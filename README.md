# 传感器设备检测检测项目

## 针对便携式角度传感器及编码器、接近开关、压力传感器的检测设备

传感器设备检测项目基于NI主板进行数据采集。其中下位机设备以NI9205、NI9403、NI9401为核心，自行搭建电路完成数据采集与处理；上位机基于QT开发，接收并处理下位机上发的各类传感器数据，响应用户操作并提供GUI界面，管理各种硬件外设；上位机与下位机之间通过USB实现数据通信。

以下针对上位机软件架构做主要说明

## 软件总体框架

软件整体架构参考经典的**MVC架构**，即模型(Model)——视图(View)——控制器(Controller)架构，基于运行环境的依赖关系划分为界面交互层、业务处理层和系统交互层，软件架构与各层主要功能如图所示。

![软件架构](1.png)

第一层是**界面交互层**，主要提供GUI界面，接收与用户请求并返回所需显示的信息，负责显示软件各级窗口和菜单，在传感器上发数据过程中绘制对应数据曲线。界面交互层会根据用户请求或软件运行状态，通过接口调用其他各层的模块功能，主要功能逻辑以来Qt框架实现。

第二层是**业务处理层**，是应用程序的核心部分，负责数据的组织和维护，具体实现各项操作的业务逻辑。业务处理层需要为界面交互提供交互接口，对上层屏蔽计算流程，同时要从下层获取数据并处理，需要合理规划功能模块，并根据系统数据流的不同阶段及需求设计数据结构。

第三层是**系统交互层**，主要操作与操作系统相关，负责调用系统API和驱动程序实现软件功能，如读写USB设备、外设驱动程序操作、读取文件等。

三个层次是一种自上到下的关系，上层架构可以获取下层架构的数据并调用相关的功能方法，下层数据需要通过回调等形式将数据传递给上层。三层架构的划分有助于降低软件内模块的耦合性，每一层只需要注重本层承担功能的实现，通过函数方法获得其他层级内的信息，不需要关注层级外的功能逻辑实现。

## 功能模块设计

### 界面交互层

#### GUI模块

​	该模块用于处理图形用户界面绘制、响应用户操作并调用其他功能模块方法。基于Qt框架实现图形用户界面，每个界面可以生成后缀名为“.ui”的窗体定义文件，并在与窗体文件同名的C++类中实现具体功能，窗体控件可通过窗体类中的ui指针访问。Qt 框架可以通过信号和槽（Signals ＆ Slots）机制在图形界面内实现函数功能调用，通过事件机制响应键盘、鼠标、触屏等用户操作。

#### 数据图线绘制

​	数据图线绘制模块负责将经过处理的传感器数据在屏幕显示，不同于GUI模块中对用户操作的处理，该模块有更高的实时性要求，因此将其单独划分为一个模块。

### 业务处理层

#### 参数配置模块

​	在软件运行过程中依赖多种参数，一部分参数用于表示不同传感器的特征，如角位移编码器每圈脉冲数、角位移传感器电机运行速度、接近开关的触发距离等，另一部分参数表示控制软件运行状态，如系统语言、用户信息等。模块需要提供参数读写接口，对参数值进行判断以保证数据有效性，并以一定规则和数据结构输出参数，提供给数据处理和通信模块以实现对下位机工作模式的控制，提供给文件读写模块以实现参数本地保存。参数修改过程及结果需要在GUI界面中体现，模块内需要制定相应的功能接口。

#### 数据处理模块

​	经数据通信模块接收的传感器数据需要进行处理，以供其他模块使用。对于接收
的传感器数据，需要基于采集频率、采样率等因素对原始数据进行处理，同时具备信号滤波功能，根据波门参数分析特定区间内的数据，并将其转换为可供图形绘制模块显示的图形数据。
​	此外，信号采集过程中有价值的回波数据需要写入文件实现本地保存，数据处理模块需要具有读取本地保存文件的功能，便于后续离线分析与场景复现。

### 系统交互层

#### 数据通信模块

​	在该传感器设备检测系统中，上位机软件与下位机设备间的通信主要通过USB实现。对于控制软件而言，USB通信基于操作系统内的应用程序库与I/O 资源实现，并不直接与外围设备进行交互。在采集过程中，数据通信模块接收传感器原始数据并按照通信协议进行解析和重组，通过校验的有效数据将送入软件内进行后续处理。经过修改的控制数据也需要按照通信协议进行封装，通过USB 送入下位机数字控制模块中以实现功能改变。

#### 文件读写

​	将数据写入文件并保存可以减少软件运行过程中的内存占用，并在后续操作流程中重新读取文件内的数据和信息，提高软件使用效率和重复利用性。根据软件架构，需要执行文件读写操作的数据主要有系统参数配置和调试数据，传感器数据会被保存为txt明码格式。

## 软件工作流程

### 软件工作流程UML序列图

![UML序列图](D:\1_ZJU\Proj_ZJU_309\Proj_sensor\Final_Proj\Proj_Sensor\2.png)

### 模块多线程实现

​	界面表现层需要及时渲染并显示传感器数据图像，如果在GUI界面中直接调用数据通信和处理函数，由于较高的采集频率，会造成界面卡顿，影响软件性能与使用体验。本项目使用的微型电脑CPU为英特尔12代N100，四核四线程，拥有12G的内存和128G固态硬盘，可以通过多线程设计充分利用CPU资源，提高软件数据处理性能。

​	本项目将软件工作流程划分为3级线程，如图所示。其中，第一级线程负责GUI模块的运行，负责图形界面显示与响应用户操作，是软件的主线程；第二级线程负责数据处理和图形渲染，对应数据处理模块和图形绘制模块的主要功能；第三级线程负责USB 数据读写，通信协议封包与解包，对应数据通信模块的主要功能。

![功能模块多线程划分](D:\1_ZJU\Proj_ZJU_309\Proj_sensor\Final_Proj\Proj_Sensor\3.png)







